version: 2.1

orbs:
  heroku: circleci/heroku@1.2.6

workflows:
  heroku_deploy: 
    jobs:
      - build-and-test
      - deploy-image:
          requires: 
          - build-and-test
jobs:
  build-and-test:
    docker:
      - image: cimg/openjdk:11.0
    steps:
      - checkout
      - run:
          name: Build
          command: make package
      - run:
          name: Test
          command: make test
  deploy-image:
    docker:
      - image: cimg/openjdk:11.0
      - image: docker:17.05.0-ce-git
    steps:
      - checkout
      - setup_remote_docker:
          version: 19.03.13
      - run:
          name: Build Docker Image
          command: make docker-image-build
<<<<<<< HEAD
=======
  deploy:
    docker:
      - image: cimg/openjdk:11.0
      - image: docker:17.05.0-ce-git
    steps:
      - checkout
      - setup_remote_docker:
          version: 19.03.13
>>>>>>> eec8e1d55a2a0d87203b5e7b480d1eeeac464f27
      - heroku/install
      - run: heroku container:login
      - run:
          name: Push image to Registry
          command: make push-image
      - run:
          name: Deploy
          command: make deploy


      

